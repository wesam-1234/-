<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø³Ø£Ù„Ù†ÙŠ Ø¨ØµØ±Ø§Ø­Ø© | Ø¨Ø¥Ø¯Ø§Ø±Ø© ÙˆØ³Ø§Ù…</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background: #f0f9ff;
            -webkit-tap-highlight-color: transparent;
        }
        .vibrant-gradient {
            background: linear-gradient(135deg, #38bdf8 0%, #fbbf24 100%);
        }
        .btn-action {
            background: #f59e0b;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-action:hover {
            background: #d97706;
            transform: translateY(-2px);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        
        select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%230369a1' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: left 1rem center;
            background-size: 1.2em;
        }

        #adminModal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 100;
            align-items: center;
            justify-content: center;
            padding: 15px;
        }
    </style>
</head>
<body class="text-gray-800 antialiased">

    <!-- Header -->
    <header class="fixed w-full z-50 bg-white/80 backdrop-blur-md border-b border-sky-100">
        <nav class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="text-xl font-bold text-sky-600 flex items-center gap-2">
                <span>ğŸ’¬</span> <span>Ø§Ø³Ø£Ù„Ù†ÙŠ Ø¨ØµØ±Ø§Ø­Ø©</span>
            </div>
            <div class="text-xs text-sky-800 font-bold bg-sky-50 px-3 py-1 rounded-full border border-sky-100">
                Ø§Ù„Ù…Ø¯ÙŠØ±: ÙˆØ³Ø§Ù… âœ¨
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <section class="pt-24 pb-12 vibrant-gradient min-h-screen flex items-center">
        <div class="container mx-auto px-4">
            <div class="grid lg:grid-cols-2 gap-10 items-center">
                
                <div class="text-white text-center lg:text-right">
                    <h1 class="text-4xl md:text-6xl font-bold mb-4">Ø§Ø³Ø£Ù„Ù†ÙŠ Ø¨ØµØ±Ø§Ø­Ø© ğŸ™ï¸</h1>
                    <p class="text-lg md:text-xl mb-8 font-medium text-sky-900">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù…Ù†ØµØ© Ø§Ù„Ù…Ø¯ÙŠØ± ÙˆØ³Ø§Ù…. Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø³Ø­Ø§Ø¨ÙŠØ© Ø¢Ù…Ù†Ø©.</p>
                </div>

                <!-- Submission Form -->
                <div id="register" class="glass-card p-6 md:p-8 rounded-3xl shadow-2xl max-w-md mx-auto w-full">
                    <h2 class="text-xl font-bold mb-6 text-center text-sky-800">ØªØ­Ø¯Ø« Ù…Ø¹ ÙˆØ³Ø§Ù… âœï¸</h2>
                    <form id="registrationForm" onsubmit="handleRegistration(event)" class="space-y-4">
                        <div>
                            <label class="block text-sm font-bold text-sky-700 mb-2">Ø§Ù„Ø§Ø³Ù…</label>
                            <input type="text" id="userName" required class="w-full px-4 py-3 rounded-xl border border-sky-100 focus:ring-2 focus:ring-yellow-400 outline-none" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-sky-700 mb-2">Ù…Ù† ØªØ­Ø¨ Ù…Ù† Ø£ØµØ¯Ù‚Ø§Ø¦ÙƒØŸ</label>
                            <select id="favoriteFriend" required class="w-full px-4 py-3 rounded-xl border border-sky-100 focus:ring-2 focus:ring-yellow-400 outline-none">
                                <option value="" disabled selected>Ø§Ø®ØªØ± ØµØ¯ÙŠÙ‚Ùƒ Ø§Ù„Ù…ÙØ¶Ù„...</option>
                                <option value="Ø§Ù„Ù…Ø¹ØªÙ…Ø¯">Ø§Ù„Ù…Ø¹ØªÙ…Ø¯</option>
                                <option value="Ø³Ù‡ÙŠÙ„">Ø³Ù‡ÙŠÙ„</option>
                                <option value="Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø­Ù…Ù†">Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø­Ù…Ù†</option>
                                <option value="ØªØ±ÙƒÙŠ">ØªØ±ÙƒÙŠ</option>
                                <option value="ÙˆØ³Ø§Ù…">ÙˆØ³Ø§Ù…</option>
                                <option value="Ù‡Ù„Ø§Ù„">Ù‡Ù„Ø§Ù„</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-sky-700 mb-2">Ø±Ø³Ø§Ù„ØªÙƒ Ù„Ù„Ù…Ø¯ÙŠØ± ÙˆØ³Ø§Ù…</label>
                            <textarea id="userMessage" rows="3" class="w-full px-4 py-3 rounded-xl border border-sky-100 focus:ring-2 focus:ring-yellow-400 outline-none" placeholder="Ø§ÙƒØªØ¨ Ø¨ØµØ±Ø§Ø­Ø©..."></textarea>
                        </div>
                        <button type="submit" id="submitBtn" class="w-full btn-action text-white font-bold py-4 rounded-xl shadow-lg">Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø¯ÙŠØ± ğŸ‰</button>
                    </form>

                    <div id="successMessage" class="hidden mt-6 p-6 bg-yellow-100 text-yellow-800 rounded-2xl text-center font-bold">
                        <div class="text-3xl mb-2">ğŸˆ</div>
                        ØªÙ… Ø­ÙØ¸ Ø±Ø³Ø§Ù„ØªÙƒ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.. <br>
                        Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø±Ø¯ Ù…Ù† ÙˆØ³Ø§Ù…
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Admin Access -->
    <section class="py-10 bg-gray-100 text-center">
        <button onclick="openAdminModal()" class="text-gray-400 hover:text-sky-600 text-sm transition-colors">
             ğŸ”’ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ±
        </button>
    </section>

    <!-- Admin Modal -->
    <div id="adminModal">
        <div class="bg-white rounded-3xl w-full max-w-2xl max-h-[85vh] overflow-hidden flex flex-col shadow-2xl relative">
            <div id="adminAuth" class="p-8 text-center">
                <h2 class="text-2xl font-bold text-sky-800 mb-6">Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø¯ÙŠØ± ÙˆØ³Ø§Ù… ğŸ‘‘</h2>
                <input type="password" id="adminPassword" class="w-full max-w-xs px-4 py-3 rounded-xl border border-gray-200 mb-4 text-center text-lg outline-none" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                <div class="flex gap-3 justify-center">
                    <button onclick="checkAdminPassword()" class="bg-sky-600 text-white px-8 py-3 rounded-xl font-bold">Ø¯Ø®ÙˆÙ„</button>
                    <button onclick="closeAdminModal()" class="bg-gray-100 text-gray-600 px-8 py-3 rounded-xl font-bold">Ø¥ØºÙ„Ø§Ù‚</button>
                </div>
            </div>

            <div id="adminDashboard" class="hidden flex-col h-full">
                <div class="p-5 border-b flex justify-between items-center bg-sky-600 text-white">
                    <h2 class="font-bold">Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ© ğŸ“Š</h2>
                    <button onclick="closeAdminModal()" class="bg-white/20 px-3 py-1 rounded-lg text-xs">Ø®Ø±ÙˆØ¬</button>
                </div>
                <div class="flex-1 overflow-auto p-4 bg-gray-50" id="adminContent">
                    <p class="text-center py-10 text-gray-400">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
                </div>
                <div class="p-4 border-t bg-white">
                    <button onclick="clearAllData()" class="w-full py-2 bg-red-50 text-red-600 border border-red-100 rounded-xl text-sm font-bold">Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, onSnapshot, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Global Variables
        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Critical: Strict adherence to Rule 1 for path structure
        const messagesCollection = collection(db, 'artifacts', appId, 'public', 'data', 'user_messages');

        let user = null;

        // Rule 3: Auth Before Queries
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error("Auth failed:", err);
            }
        };

        initAuth();

        onAuthStateChanged(auth, (u) => {
            user = u;
            console.log(u ? `Connected as ${u.uid}` : "Disconnected");
        });

        window.handleRegistration = async (event) => {
            event.preventDefault();
            
            // Guard: Must be authenticated
            if (!user) {
                console.log("Waiting for auth...");
                await initAuth();
                if(!auth.currentUser) {
                    alert("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ø­Ø§Ù„ÙŠØ§Ù‹. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
                    return;
                }
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸ Ø¨Ø£Ù…Ø§Ù†...";

            try {
                const payload = {
                    name: document.getElementById('userName').value,
                    friend: document.getElementById('favoriteFriend').value,
                    message: document.getElementById('userMessage').value,
                    timestamp: serverTimestamp(),
                    dateDisplay: new Date().toLocaleString('ar-EG'),
                    userId: auth.currentUser.uid
                };

                await addDoc(messagesCollection, payload);

                document.getElementById('registrationForm').classList.add('hidden');
                document.getElementById('successMessage').classList.remove('hidden');
            } catch (error) {
                console.error("Critical Save Error:", error);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ùƒ ØªØªØ¨Ø¹ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ØµØ­ÙŠØ­Ø©.");
                submitBtn.disabled = false;
                submitBtn.innerText = "Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ğŸ”„";
            }
        };

        window.loadAdminData = () => {
            const container = document.getElementById('adminContent');
            
            if (!user) {
                container.innerHTML = `<p class="text-center py-10 text-sky-600">Ø¬Ø§Ø±ÙŠ ØªØ£Ù…ÙŠÙ† Ø§Ù„Ø§ØªØµØ§Ù„...</p>`;
                setTimeout(window.loadAdminData, 1000);
                return;
            }

            // Real-time listener with error callback
            onSnapshot(messagesCollection, (snapshot) => {
                const messages = [];
                snapshot.forEach((doc) => {
                    messages.push({ id: doc.id, ...doc.data() });
                });

                // Rule 2: Sort in memory instead of query
                messages.sort((a, b) => {
                    const timeA = a.timestamp?.seconds || 0;
                    const timeB = b.timestamp?.seconds || 0;
                    return timeB - timeA;
                });

                if (messages.length === 0) {
                    container.innerHTML = `<p class="text-center py-10 text-gray-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø³Ø­Ø§Ø¨ÙŠØ© Ø­Ø§Ù„ÙŠØ§Ù‹.</p>`;
                    return;
                }

                container.innerHTML = messages.map(m => `
                    <div class="bg-white p-4 rounded-2xl mb-4 border border-gray-100 shadow-sm">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <p class="font-bold text-sky-800">${m.name}</p>
                                <p class="text-[10px] text-gray-400">${m.dateDisplay || 'Ø§Ù„Ø¢Ù†'}</p>
                                <p class="text-[8px] text-gray-300">UID: ${m.userId || 'Unknown'}</p>
                            </div>
                            <button onclick="window.deleteSingleMessage('${m.id}')" class="text-red-400 text-xs font-bold">Ø­Ø°Ù</button>
                        </div>
                        <div class="bg-sky-50 p-2 rounded-lg text-[11px] text-sky-700 font-bold mb-2">Ø§Ù„ØµØ¯ÙŠÙ‚ Ø§Ù„Ù…Ø®ØªØ§Ø±: ${m.friend}</div>
                        <p class="text-sm text-gray-600">${m.message || '(Ø¨Ø¯ÙˆÙ† Ù†Øµ)'}</p>
                    </div>
                `).join('');
            }, (error) => {
                console.error("Snapshot error:", error);
                container.innerHTML = `<div class="p-4 text-center text-red-500 text-xs">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª: ${error.message}</div>`;
            });
        };

        window.deleteSingleMessage = async (id) => {
            if (!user) return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'user_messages', id));
            } catch (err) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù: " + err.message); }
        };

        window.clearAllData = async () => {
            if (!user || !confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ")) return;
            try {
                const snapshot = await getDocs(messagesCollection);
                const deletions = snapshot.docs.map(d => deleteDoc(d.ref));
                await Promise.all(deletions);
            } catch (err) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ø´Ø§Ù…Ù„: " + err.message); }
        };
    </script>

    <script>
        function openAdminModal() {
            document.getElementById('adminModal').style.display = 'flex';
        }

        function closeAdminModal() {
            document.getElementById('adminModal').style.display = 'none';
        }

        function checkAdminPassword() {
            if (document.getElementById('adminPassword').value === "922") {
                document.getElementById('adminAuth').classList.add('hidden');
                document.getElementById('adminDashboard').classList.remove('hidden');
                document.getElementById('adminDashboard').classList.add('flex');
                if (window.loadAdminData) window.loadAdminData();
            } else {
                alert("Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­.");
            }
        }
    </script>
</body>
</html>